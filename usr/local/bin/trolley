#!/usr/bin/env python

import os
import urllib2
import json
from sys import argv

host    = 'http://boxcar-addons-staging.herokuapp.com'
command = ''
package_name    = ''
package_version = ''

# Get input
if len(argv) == 4:
  script, command, package_name, package_version = argv
elif len(argv) == 3:
  script, command, package_name = argv
else:
  print "Usage:"
  print "trolley install NAME [VERSION]  # Install a package by name. Version optional"
  print "trolley remove NAME             # Remove installed package"
  print "trolley search NAME             # Search for package. May be a fragment."
  print "trolley list                    # List installed packages"
  exit()

def get_package_data(path):
  response = urllib2.urlopen(host + path)
  return json.load(response)

def install():
  print "Getting package data"
  package = get_package_data('/packages/' + package_name + '/' + package_version)

  if not package_version:
    package = package[0]

  # Download package
  print "Downloading"
  os.system('wget -q http://slackware.cs.utah.edu/pub/slackware/' + package['path'])

  # Install package
  print "Installing"
  os.system('installpkg ' + package['package_name'])

def remove():
  os.system('removepkg ' + package_name)

def search():
  packages = get_package_data('/packages/search?q=' + package_name)

  if packages:
    for p in packages:
      print p['name'] + " (" + ', '.join(p['versions']) + ")"

def list():
  installed_packages = os.listdir('/var/log/packages/')
  for package in installed_packages:
    print package

exec(command + '()')
